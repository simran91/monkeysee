package main

import "fmt"
import "./monkey"
import "./mods"
import "regexp"
import "./util"
import "path/filepath"
import "reflect"
import "runtime"
import "strings"
import "os"

//
// Demo program to show the usage of the functions and some of the mods provided...
//
func main() {

	sourceDir := "samples"
	destDir := "samples/autogenerated"
	sourceFiles := []string{}

	if (len(os.Args) > 1) {
		sourceFiles = os.Args[1:]
	} else {
		sourceFiles = []string{
			"rgb.png",
			"rgb.jpg",
			"rgb.gif",
			"forest.png",
			"flower.jpg",
		}
	}

	// Compile the regex on where the '.' is so that we can parse filenames and save to new filenames later
	stringRegex := regexp.MustCompile(`\.`)

	for _, sourceFile := range sourceFiles {
		fmt.Println("************************************************************")
		fmt.Println("In:", filepath.Join(sourceDir, sourceFile))
		fmt.Println("************************************************************")

		image := monkey.LoadImageFromFile(filepath.Join(sourceDir, sourceFile))
		destFileInit := string(stringRegex.ReplaceAll([]byte(sourceFile), []byte{'-'}))
		
		// runMod(modSwapRGBtoGBR, destDir, destFileInit, image.ColourMatrix())
		// runMod(modGreyscaleAverageWithTranslusence, destDir, destFileInit, image.ColourMatrix())
		// runMod(modBlur, destDir, destFileInit, image.ColourMatrix(), 8)
		// runMod(modBlurWithKernelMethod, destDir, destFileInit, image.ColourMatrix(), 8)
		// runMod(modGaussianBlur, destDir, destFileInit, image.ColourMatrix())
		// runMod(modAverageBlur, destDir, destFileInit, image.ColourMatrix())
		runMod(modApplyConvolutionWithSampleFunction, destDir, destFileInit, image.ColourMatrix())
	}
}

// get the name of the funciton... will start with "main." as we are in the main package here!
func getFunctionName(i interface{}) string {
	return runtime.FuncForPC(reflect.ValueOf(i).Pointer()).Name()
}

// call the correct mod function as required...
func runMod(modfunc func(string, string, monkey.ImageMatrix, ...interface{}) monkey.ImageMatrix,
	destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) {
	// Get the function name so that we can use it in the directory/filenames we create...
	modName := getFunctionName(modfunc)
	modName = strings.Replace(modName, "main.mod", "", 1)

	// Inform the user on which function we are about to run...
	fmt.Printf("Running mod %v\n", modName)

	// Ensure the destination directory exists...
	destDir = filepath.Join(destDir, modName)
	err := os.MkdirAll(destDir, os.ModePerm)
	util.CheckError(err)

	// Call the actual mod func and create the new image...
	newColourMatrix := modfunc(destDir, destFileInit, colourMatrix, vars...)
	newImage := monkey.ColourMatrixToImage(newColourMatrix)

	// Save as PNG
	destImage := filepath.Join(destDir, destFileInit+"-to-png.png")
	fmt.Println("Out:", destImage)
	util.SaveImageToFileAsPNG(destImage, newImage)

	// Save as JPG
	destImage = filepath.Join(destDir, destFileInit+"-to-jpg.jpg")
	fmt.Println("Out:", destImage)
	util.SaveImageToFileAsJPG(destImage, newImage)

	// Save as GIF
	destImage = filepath.Join(destDir, destFileInit+"-to-gif.gif")
	fmt.Println("Out:", destImage)
	util.SaveImageToFileAsGIF(destImage, newImage)

	fmt.Println()
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: SwapRGBtoGBR
//
func modSwapRGBtoGBR(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	newColourMatrix := mods.SwapRGBtoGBR(colourMatrix)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: GreyscaleAverageWithTranslusence
//
func modGreyscaleAverageWithTranslusence(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	newColourMatrix := mods.GreyscaleAverageWithTranslusence(colourMatrix)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: Blur
//
func modBlur(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	blurAmount := vars[0].(int)
	newColourMatrix := mods.Blur(colourMatrix, blurAmount)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: modBlurWithKernelMethod
//
func modBlurWithKernelMethod(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	blurAmount := vars[0].(int)
	newColourMatrix := mods.BlurWithKernelMethod(colourMatrix, blurAmount)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: modGaussianBlur
//
func modGaussianBlur(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	newColourMatrix := mods.GaussianBlur(colourMatrix)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: modAverageBlur
//
func modAverageBlur(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	newColourMatrix := mods.AverageBlur(colourMatrix)
	return newColourMatrix
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
// mod: modApplyConvolutionWithSampleFunction
//
func modApplyConvolutionWithSampleFunction(destDir, destFileInit string, colourMatrix monkey.ImageMatrix, vars ...interface{}) monkey.ImageMatrix {
	newColourMatrix := mods.ApplyConvolutionWithSampleFunction(colourMatrix)
	return newColourMatrix
}
